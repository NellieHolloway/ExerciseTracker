<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exercise Tracker</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#eff6ff,#e0e7ff);min-height:100vh}
    .container{max-width:56rem;margin:0 auto;padding:1rem}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);padding:1.5rem;margin-bottom:1.5rem}
    .flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-between{justify-content:space-between}.flex-wrap{flex-wrap:wrap}
    .gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}
    .grid{display:grid}.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}.grid-4{grid-template-columns:repeat(4,1fr)}
    .mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.ml-2{margin-left:0.5rem}.mr-2{margin-right:0.5rem}
    .p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}
    .w-full{width:100%}.flex-1{flex:1}.shrink-0{flex-shrink:0}
    .text-xs{font-size:0.75rem}.text-sm{font-size:0.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}
    .font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}
    .text-white{color:#fff}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-800{color:#1f2937}
    .text-red-600{color:#dc2626}.text-indigo-600{color:#4f46e5}.text-indigo-100{color:#e0e7ff}
    .text-green-600{color:#16a34a}.text-green-700{color:#15803d}.text-green-800{color:#166534}
    .text-blue-700{color:#1d4ed8}.text-blue-800{color:#1e40af}.text-blue-900{color:#1e3a8a}
    .text-orange-600{color:#ea580c}.text-orange-700{color:#c2410c}.text-orange-800{color:#9a3412}
    .text-purple-700{color:#7e22ce}.text-purple-800{color:#6b21a8}
    .text-indigo-700{color:#4338ca}.text-indigo-800{color:#3730a3}
    .text-pink-700{color:#be185d}.text-pink-800{color:#9d174d}
    .text-teal-700{color:#0f766e}.text-teal-800{color:#115e59}
    .text-amber-700{color:#b45309}.text-amber-800{color:#92400e}
    .bg-white{background:#fff}.bg-gray-50{background:#f9fafb}.bg-gray-100{background:#f3f4f6}.bg-gray-200{background:#e5e7eb}.bg-gray-400{background:#9ca3af}
    .bg-red-600{background:#dc2626}.bg-green-600{background:#16a34a}.bg-blue-600{background:#2563eb}.bg-indigo-600{background:#4f46e5}
    .bg-blue-50{background:#eff6ff}.bg-amber-50{background:#fffbeb}.bg-green-50{background:#f0fdf4}
    .grad-green{background:linear-gradient(135deg,#f0fdf4,#dcfce7)}.grad-blue{background:linear-gradient(135deg,#eff6ff,#dbeafe)}
    .grad-orange{background:linear-gradient(135deg,#fff7ed,#ffedd5)}.grad-purple{background:linear-gradient(135deg,#faf5ff,#f3e8ff)}
    .grad-indigo{background:linear-gradient(135deg,#eef2ff,#e0e7ff)}.grad-pink{background:linear-gradient(135deg,#fdf2f8,#fce7f3)}
    .grad-teal{background:linear-gradient(135deg,#f0fdfa,#ccfbf1)}.grad-gray{background:linear-gradient(90deg,#f9fafb,#f3f4f6)}
    .grad-amber{background:linear-gradient(135deg,#fffbeb,#fef3c7)}
    .grad-header{background:linear-gradient(90deg,#6366f1,#9333ea)}
    .rounded{border-radius:0.25rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded-full{border-radius:9999px}
    .border{border:1px solid}.border-2{border:2px solid}.border-gray-200{border-color:#e5e7eb}.border-gray-300{border-color:#d1d5db}.border-blue-200{border-color:#bfdbfe}.border-green-300{border-color:#86efac}.border-amber-300{border-color:#fcd34d}
    .shadow-2xl{box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)}
    .cursor-pointer{cursor:pointer}.overflow-auto{overflow-y:auto}.overflow-hidden{overflow:hidden}.max-h-96{max-height:24rem}.max-h-64{max-height:16rem}
    .fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.z-50{z-index:50}
    .overlay{background:rgba(0,0,0,0.5)}
    .truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .hidden{display:none}
    button{border:none;cursor:pointer;font-family:inherit;transition:all 0.15s}
    button:hover:not(:disabled){filter:brightness(0.92)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    input,select{font-family:inherit;font-size:1rem;padding:0.5rem 0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;outline:none;width:100%}
    input:focus,select:focus{border-color:#6366f1}
    .icon{display:inline-flex;align-items:center;justify-content:center}
    .progress-bar{height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
    .progress-fill{height:100%;border-radius:4px;transition:width 0.3s ease}
    .chart-bar{transition:height 0.3s ease}
    .streak-badge{display:inline-flex;align-items:center;gap:0.25rem;padding:0.25rem 0.5rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
    .quick-log-btn{padding:0.5rem 1rem;border-radius:0.5rem;font-weight:500;background:#f3f4f6;color:#4b5563;border:2px solid transparent}
    .quick-log-btn:hover{background:#e5e7eb}
    .quick-log-btn.selected{background:#eef2ff;border-color:#6366f1;color:#4f46e5}
    @media(max-width:768px){
      .grid-3,.grid-4{grid-template-columns:repeat(2,1fr)}
      .hide-mobile{display:none}
      .mobile-full{grid-template-columns:1fr}
    }
    @media(max-width:480px){
      .grid-2{grid-template-columns:1fr}
      .container{padding:0.5rem}
      .card{padding:1rem}
    }
  </style>
</head>
<body>
<div class="container" id="app"></div>

<script>
// Icons as SVG strings
const icons = {
  trend: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
  download: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
  plus: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
  calendar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
  chart: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>`,
  sort: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/></svg>`,
  trash: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
  history: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
  edit: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
  fire: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>`,
  fireLg: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>`,
  target: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
  x: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
  chevronDown: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>`,
  chevronUp: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>`,
  zap: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
  settings: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
};

function icon(name, size) {
  let svg = icons[name] || '';
  if (size) {
    svg = svg.replace(/width="\d+"/, `width="${size}"`).replace(/height="\d+"/, `height="${size}"`);
  }
  return `<span class="icon">${svg}</span>`;
}

// State
let state = {
  exercises: [],
  records: [],
  sortBy: 'dateAddedNewest',
  showAddExercise: false,
  showHistory: false,
  showDailyStats: false,
  showImport: false,
  selectedExerciseId: null,
  amount: '',
  recordDate: new Date().toISOString().split('T')[0],
  newExerciseName: '',
  historyFilter: 'all',
  expandedExercise: null,
  quickLogExerciseId: null,
  quickLogAmount: '',
  // Modals
  editExercise: null,
  editRecord: null,
  deleteConfirmId: null,
};

// Load from localStorage
function loadState() {
  try {
    const e = localStorage.getItem('ex_exercises');
    const r = localStorage.getItem('ex_records');
    if (e) state.exercises = JSON.parse(e);
    if (r) state.records = JSON.parse(r);
  } catch (err) { console.log(err); }
}

function saveExercises() {
  localStorage.setItem('ex_exercises', JSON.stringify(state.exercises));
}

function saveRecords() {
  localStorage.setItem('ex_records', JSON.stringify(state.records));
}

// Helpers
function todayStr() {
  return new Date().toISOString().split('T')[0];
}

function getStats(exerciseId) {
  const recs = state.records.filter(r => r.exerciseId === exerciseId).sort((a, b) => new Date(b.date) - new Date(a.date));
  if (!recs.length) return { max: 0, average: 0, last4Average: 0, last10Average: 0, count: 0, lastDate: null, streak: 0, chartData: [] };
  
  const amounts = recs.map(r => r.amount);
  const max = Math.max(...amounts);
  const average = amounts.reduce((a, b) => a + b, 0) / amounts.length;
  const last4 = recs.slice(0, 4);
  const last10 = recs.slice(0, 10);
  
  // Calculate streak
  let streak = 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const uniqueDates = [...new Set(recs.map(r => r.date))].sort((a, b) => new Date(b) - new Date(a));
  
  for (let i = 0; i < uniqueDates.length; i++) {
    const checkDate = new Date(today);
    checkDate.setDate(checkDate.getDate() - i);
    const checkDateStr = checkDate.toISOString().split('T')[0];
    if (uniqueDates.includes(checkDateStr)) {
      streak++;
    } else if (i === 0) {
      continue;
    } else {
      break;
    }
  }

  const chartData = recs.slice(0, 10).reverse().map(r => ({ date: r.date, amount: r.amount }));

  return {
    max, average,
    last4Average: last4.length ? last4.reduce((a, b) => a + b.amount, 0) / last4.length : 0,
    last10Average: last10.length ? last10.reduce((a, b) => a + b.amount, 0) / last10.length : 0,
    count: recs.length,
    lastDate: recs[0].date,
    streak,
    chartData
  };
}

function getTodayCount() {
  const today = todayStr();
  return new Set(state.records.filter(r => r.date === today).map(r => r.exerciseId)).size;
}

function getOverallStreak() {
  if (!state.records.length) return 0;
  const dateSet = new Set(state.records.map(r => r.date));
  let streak = 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  for (let i = 0; i < 365; i++) {
    const checkDate = new Date(today);
    checkDate.setDate(checkDate.getDate() - i);
    const checkDateStr = checkDate.toISOString().split('T')[0];
    if (dateSet.has(checkDateStr)) {
      streak++;
    } else if (i === 0) {
      continue;
    } else {
      break;
    }
  }
  return streak;
}

function getDailyStats() {
  const stats = {};
  state.records.forEach(r => { if (!stats[r.date]) stats[r.date] = new Set(); stats[r.date].add(r.exerciseId); });
  if (state.records.length) {
    const dates = state.records.map(r => new Date(r.date));
    const earliest = new Date(Math.min(...dates));
    const today = new Date();
    for (let d = new Date(earliest); d <= today; d.setDate(d.getDate() + 1)) {
      const ds = d.toISOString().split('T')[0];
      if (!stats[ds]) stats[ds] = new Set();
    }
  } else {
    stats[todayStr()] = new Set();
  }
  return Object.entries(stats).map(([date, set]) => ({ date, count: set.size })).sort((a, b) => new Date(b.date) - new Date(a.date));
}

function getSortedExercises() {
  const list = state.exercises.map(ex => {
    const s = getStats(ex.id);
    return { ...ex, logCount: s.count, lastDate: s.lastDate, percentDiff: s.max > 0 ? (s.last10Average / s.max) * 100 : 0, streak: s.streak };
  });
  switch(state.sortBy) {
    case 'dateAddedNewest': return list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    case 'dateAddedOldest': return list.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
    case 'alphabetical': return list.sort((a, b) => a.name.localeCompare(b.name));
    case 'mostLogs': return list.sort((a, b) => b.logCount - a.logCount);
    case 'fewestLogs': return list.sort((a, b) => a.logCount - b.logCount);
    case 'lastCompletedRecent': return list.sort((a, b) => { if (!a.lastDate) return 1; if (!b.lastDate) return -1; return new Date(b.lastDate) - new Date(a.lastDate); });
    case 'lastCompletedOldest': return list.sort((a, b) => { if (!a.lastDate) return 1; if (!b.lastDate) return -1; return new Date(a.lastDate) - new Date(b.lastDate); });
    case 'percentDiff': return list.sort((a, b) => b.percentDiff - a.percentDiff);
    case 'streak': return list.sort((a, b) => b.streak - a.streak);
    default: return list;
  }
}

function getFilteredHistory() {
  let filtered = [...state.records];
  if (state.historyFilter !== 'all') {
    filtered = filtered.filter(r => r.exerciseId === state.historyFilter);
  }
  return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
}

// Actions
function addExercise() {
  if (state.newExerciseName.trim()) {
    state.exercises.push({
      id: Date.now().toString(),
      name: state.newExerciseName.trim(),
      createdAt: new Date().toISOString(),
      goal: null
    });
    state.newExerciseName = '';
    state.showAddExercise = false;
    saveExercises();
    render();
  }
}

function addRecord() {
  if (state.selectedExerciseId && state.amount && state.recordDate) {
    state.records.push({
      id: Date.now().toString(),
      exerciseId: state.selectedExerciseId,
      amount: parseFloat(state.amount),
      date: state.recordDate,
      timestamp: new Date().toISOString()
    });
    state.amount = '';
    state.recordDate = todayStr();
    saveRecords();
    render();
  }
}

function quickLog() {
  if (state.quickLogExerciseId && state.quickLogAmount) {
    state.records.push({
      id: Date.now().toString(),
      exerciseId: state.quickLogExerciseId,
      amount: parseFloat(state.quickLogAmount),
      date: todayStr(),
      timestamp: new Date().toISOString()
    });
    state.quickLogAmount = '';
    state.quickLogExerciseId = null;
    saveRecords();
    render();
  }
}

function updateExercise(id, updates) {
  state.exercises = state.exercises.map(ex => ex.id === id ? { ...ex, ...updates } : ex);
  saveExercises();
}

function deleteExercise(id) {
  state.exercises = state.exercises.filter(ex => ex.id !== id);
  state.records = state.records.filter(r => r.exerciseId !== id);
  state.editExercise = null;
  saveExercises();
  saveRecords();
  render();
}

function updateRecord(id, updates) {
  state.records = state.records.map(r => r.id === id ? { ...r, ...updates } : r);
  state.editRecord = null;
  saveRecords();
  render();
}

function deleteRecord(id) {
  state.records = state.records.filter(r => r.id !== id);
  state.deleteConfirmId = null;
  saveRecords();
  render();
}

function downloadData() {
  let csv = 'Exercise,Date,Amount\n';
  state.records.forEach(r => {
    const ex = state.exercises.find(e => e.id === r.exerciseId);
    if (ex) csv += `"${ex.name}","${r.date}",${r.amount}\n`;
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `exercise-tracker-${todayStr()}.csv`;
  a.click();
}

function importData(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const lines = ev.target.result.split('\n').slice(1).filter(l => l.trim());
      const newEx = [], newRec = [], exMap = {};
      lines.forEach(line => {
        const m = line.match(/("([^"]*)"|[^,]+)/g);
        if (!m || m.length < 3) return;
        const name = m[0].replace(/^"|"$/g, '').trim();
        const date = m[1].replace(/^"|"$/g, '').trim();
        const amt = parseFloat(m[2].replace(/^"|"$/g, '').trim());
        if (!name || !date || isNaN(amt)) return;
        if (!exMap[name]) {
          const id = `imp-${Date.now()}-${Math.random()}`;
          exMap[name] = id;
          newEx.push({ id, name, createdAt: new Date().toISOString(), goal: null });
        }
        newRec.push({ id: `rec-${Date.now()}-${Math.random()}`, exerciseId: exMap[name], amount: amt, date, timestamp: new Date().toISOString() });
      });
      const merged = [...state.exercises];
      newEx.forEach(ne => {
        const exists = state.exercises.find(ex => ex.name === ne.name);
        if (!exists) merged.push(ne);
        else newRec.forEach(r => { if (r.exerciseId === ne.id) r.exerciseId = exists.id; });
      });
      state.exercises = merged;
      state.records = [...state.records, ...newRec];
      state.showImport = false;
      saveExercises();
      saveRecords();
      alert(`Imported ${newRec.length} records!`);
      render();
    } catch (err) { alert('Error importing CSV'); }
  };
  reader.readAsText(file);
}

// Mini chart
function renderMiniChart(data, height = 50) {
  if (!data || data.length < 2) return '';
  const max = Math.max(...data.map(d => d.amount), 1);
  const bars = data.map((d, i) => {
    const h = (d.amount / max) * 100;
    const opacity = 0.3 + (i / data.length) * 0.7;
    return `<div class="chart-bar rounded-t" style="flex:1;height:${h}%;min-height:4px;background:#4f46e5;opacity:${opacity}" title="${d.date}: ${d.amount}"></div>`;
  }).join('');
  return `<div class="flex items-end gap-1" style="height:${height}px">${bars}</div>`;
}

// Render
function render() {
  const app = document.getElementById('app');
  const todayCount = getTodayCount();
  const overallStreak = getOverallStreak();
  const sortedExercises = getSortedExercises();
  
  let html = '';
  
  // Header Card
  html += `
    <div class="card">
      <div class="flex items-center justify-between gap-4 mb-4 flex-wrap">
        <div class="flex items-center gap-3">
          <div class="bg-indigo-600 p-3 rounded-xl text-white">${icon('trend', 28)}</div>
          <div>
            <h1 class="text-2xl font-bold text-gray-800">Exercise Tracker</h1>
            <p class="text-gray-600 text-sm">Track your fitness progress</p>
          </div>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button onclick="downloadData()" ${!state.records.length ? 'disabled' : ''} class="flex items-center gap-2 bg-green-600 text-white p-2 px-3 rounded-lg font-medium text-sm">
            ${icon('download', 16)} Export
          </button>
          <button onclick="state.showImport=true;render()" class="flex items-center gap-2 bg-blue-600 text-white p-2 px-3 rounded-lg font-medium text-sm">
            ${icon('plus', 16)} Import
          </button>
        </div>
      </div>
      
      <div class="grad-header rounded-xl p-4 text-white cursor-pointer" onclick="state.showDailyStats=!state.showDailyStats;render()">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex-1">
            <p class="text-indigo-100 text-xs font-semibold mb-1">TODAY'S PROGRESS</p>
            <p class="text-2xl font-bold">${todayCount} Exercise${todayCount !== 1 ? 's' : ''} Completed</p>
            <p class="text-indigo-100 text-xs mt-1">Click to view daily history</p>
          </div>
          <div class="flex items-center gap-3">
            ${overallStreak > 0 ? `
              <div class="flex items-center gap-2 bg-white/20 rounded-lg p-2 px-3">
                ${icon('fireLg')}
                <div>
                  <p class="text-xs opacity-80">Streak</p>
                  <p class="font-bold">${overallStreak} day${overallStreak !== 1 ? 's' : ''}</p>
                </div>
              </div>
            ` : ''}
            <div class="bg-white/20 p-3 rounded-lg hide-mobile">${icon('calendar', 28)}</div>
          </div>
        </div>
      </div>
    </div>
  `;

  // Quick Log
  if (state.exercises.length > 0) {
    html += `
      <div class="card">
        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
          <span class="text-orange-600">${icon('zap')}</span> Quick Log
        </h2>
        <div class="flex gap-2 flex-wrap mb-3">
          ${state.exercises.slice(0, 6).map(ex => `
            <button onclick="state.quickLogExerciseId=state.quickLogExerciseId==='${ex.id}'?null:'${ex.id}';state.quickLogAmount='';render();setTimeout(()=>{const el=document.getElementById('quickAmountInput');if(el)el.focus();},0)" class="quick-log-btn ${state.quickLogExerciseId === ex.id ? 'selected' : ''}">
              ${ex.name}
            </button>
          `).join('')}
        </div>
        ${state.quickLogExerciseId ? `
          <div class="flex gap-2 items-center bg-gray-50 p-3 rounded-lg">
            <span class="text-sm font-medium text-gray-600">${state.exercises.find(e => e.id === state.quickLogExerciseId)?.name}:</span>
            <input id="quickAmountInput" type="number" value="${state.quickLogAmount}" oninput="state.quickLogAmount=this.value" onkeypress="if(event.key==='Enter')quickLog()" placeholder="Amount" class="flex-1" style="max-width:120px">
            <button onclick="quickLog()" ${!state.quickLogAmount ? 'disabled' : ''} class="bg-indigo-600 text-white p-2 px-4 rounded-lg font-medium">Log</button>
            <button onclick="state.quickLogExerciseId=null;state.quickLogAmount='';render()" class="text-gray-500 p-2">${icon('x')}</button>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Daily Stats
  if (state.showDailyStats) {
    const dailyStats = getDailyStats();
    html += `
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><span class="text-indigo-600">${icon('chart', 20)}</span> Daily History</h2>
          <button onclick="state.showDailyStats=false;render()" class="text-gray-500 text-sm bg-gray-100 p-2 px-3 rounded-lg">Close</button>
        </div>
        <div class="overflow-auto max-h-64">
          ${dailyStats.map(s => {
            const d = new Date(s.date + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            const days = Math.floor((today - d) / 86400000);
            const label = days === 0 ? 'Today' : days === 1 ? 'Yesterday' : `${days}d ago`;
            return `
              <div class="flex items-center justify-between p-3 rounded-lg mb-2 ${s.count === 0 ? 'grad-gray' : 'grad-indigo'}">
                <div>
                  <p class="font-medium text-gray-800 text-sm">${d.toLocaleDateString('en-US', {weekday:'short',month:'short',day:'numeric'})}</p>
                  <p class="text-xs text-gray-500">${label}</p>
                </div>
                <div class="py-1 px-3 rounded-lg font-bold text-white text-sm ${s.count === 0 ? 'bg-gray-400' : 'bg-indigo-600'}">${s.count}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }

  // Add Exercise
  html += `
    <div class="card">
      <button onclick="state.showAddExercise=!state.showAddExercise;render()" class="flex items-center gap-2 bg-indigo-600 text-white p-3 rounded-lg w-full justify-center font-semibold">
        ${icon('plus', 20)} Add New Exercise
      </button>
      ${state.showAddExercise ? `
        <div class="flex gap-2 mt-4">
          <input type="text" id="newExerciseInput" value="${state.newExerciseName}" oninput="state.newExerciseName=this.value" onkeypress="if(event.key==='Enter')addExercise()" placeholder="Exercise name" class="flex-1">
          <button onclick="addExercise()" class="bg-indigo-600 text-white p-3 rounded-lg font-medium">Add</button>
        </div>
      ` : ''}
    </div>
  `;

  // Log Workout
  if (state.exercises.length > 0) {
    html += `
      <div class="card">
        <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><span class="text-indigo-600">${icon('calendar', 20)}</span> Log Workout</h2>
        <div class="grid grid-3 gap-3 mobile-full">
          <select onchange="state.selectedExerciseId=this.value||null" value="${state.selectedExerciseId || ''}">
            <option value="">Select exercise</option>
            ${state.exercises.map(ex => `<option value="${ex.id}" ${state.selectedExerciseId === ex.id ? 'selected' : ''}>${ex.name}</option>`).join('')}
          </select>
          <input type="number" value="${state.amount}" oninput="state.amount=this.value" placeholder="Amount">
          <input type="date" value="${state.recordDate}" oninput="state.recordDate=this.value">
        </div>
        <button onclick="addRecord()" ${!state.selectedExerciseId || !state.amount ? 'disabled' : ''} class="mt-4 w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold">Log Exercise</button>
      </div>
    `;
  }

  // Statistics
  if (state.exercises.length > 0) {
    html += `
      <div class="card">
        <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
          <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><span class="text-indigo-600">${icon('chart', 20)}</span> Statistics</h2>
          <div class="flex items-center gap-2">
            <span class="text-gray-500">${icon('sort')}</span>
            <select value="${state.sortBy}" onchange="state.sortBy=this.value;render()" style="font-size:0.8rem;padding:0.4rem 0.6rem">
              <option value="dateAddedNewest" ${state.sortBy === 'dateAddedNewest' ? 'selected' : ''}>Date Added (Newest)</option>
              <option value="dateAddedOldest" ${state.sortBy === 'dateAddedOldest' ? 'selected' : ''}>Date Added (Oldest)</option>
              <option value="alphabetical" ${state.sortBy === 'alphabetical' ? 'selected' : ''}>Alphabetical</option>
              <option value="mostLogs" ${state.sortBy === 'mostLogs' ? 'selected' : ''}>Most Logs</option>
              <option value="fewestLogs" ${state.sortBy === 'fewestLogs' ? 'selected' : ''}>Fewest Logs</option>
              <option value="lastCompletedRecent" ${state.sortBy === 'lastCompletedRecent' ? 'selected' : ''}>Last Completed (Recent)</option>
              <option value="lastCompletedOldest" ${state.sortBy === 'lastCompletedOldest' ? 'selected' : ''}>Last Completed (Oldest)</option>
              <option value="percentDiff" ${state.sortBy === 'percentDiff' ? 'selected' : ''}>L10 AVG/MAX %</option>
              <option value="streak" ${state.sortBy === 'streak' ? 'selected' : ''}>Streak</option>
            </select>
          </div>
        </div>
        ${sortedExercises.map(ex => {
          const s = getStats(ex.id);
          const pct = s.max > 0 ? (s.last10Average / s.max) * 100 : 0;
          const goalProgress = ex.goal && s.last10Average > 0 ? (s.last10Average / ex.goal) * 100 : null;
          const isExpanded = state.expandedExercise === ex.id;
          let lastDateInfo = null;
          if (s.lastDate) {
            const ld = new Date(s.lastDate + 'T00:00:00');
            const today = new Date(); today.setHours(0,0,0,0);
            const days = Math.floor((today - ld) / 86400000);
            lastDateInfo = { text: ld.toLocaleDateString('en-US',{month:'short',day:'numeric'}), days };
          }
          
          return `
            <div class="border-2 border-gray-200 rounded-xl p-4 mb-3">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <h3 class="font-bold text-gray-800 truncate">${ex.name}</h3>
                  ${s.streak > 0 ? `<span class="streak-badge bg-amber-50 text-amber-700 border border-amber-300 shrink-0">${icon('fire')} ${s.streak}</span>` : ''}
                </div>
                <div class="flex items-center gap-1 shrink-0">
                  <button onclick="state.editExercise={...state.exercises.find(e=>e.id==='${ex.id}')};render()" class="p-2 text-gray-500 bg-gray-100 rounded-lg">${icon('settings')}</button>
                  <button onclick="state.expandedExercise=state.expandedExercise==='${ex.id}'?null:'${ex.id}';render()" class="p-2 text-gray-500 bg-gray-100 rounded-lg">${icon(isExpanded ? 'chevronUp' : 'chevronDown')}</button>
                </div>
              </div>
              
              ${ex.goal ? `
                <div class="mb-3 p-2 bg-green-50 rounded-lg border border-green-300">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-semibold text-green-700 flex items-center gap-1">${icon('target')} Goal: ${ex.goal}</span>
                    <span class="text-xs font-bold text-green-800">${goalProgress?.toFixed(0)}%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width:${Math.min(goalProgress || 0, 100)}%;background:${goalProgress >= 100 ? '#16a34a' : '#4f46e5'}"></div>
                  </div>
                </div>
              ` : ''}
              
              <div class="grid grid-3 gap-3 mb-3">
                <div class="grad-green p-2 rounded-lg"><p class="text-xs text-green-700 font-semibold">MAX</p><p class="text-xl font-bold text-green-800">${s.max.toFixed(1)}</p></div>
                <div class="grad-blue p-2 rounded-lg"><p class="text-xs text-blue-700 font-semibold">AVG</p><p class="text-xl font-bold text-blue-800">${s.average.toFixed(1)}</p></div>
                <div class="grad-orange p-2 rounded-lg"><p class="text-xs text-orange-700 font-semibold">LOGS</p><p class="text-xl font-bold text-orange-800">${s.count}</p></div>
              </div>
              
              ${isExpanded ? `
                <div class="grid grid-4 gap-3 mb-3">
                  <div class="grad-purple p-2 rounded-lg"><p class="text-xs text-purple-700 font-semibold">L4 AVG</p><p class="text-lg font-bold text-purple-800">${s.last4Average.toFixed(1)}</p></div>
                  <div class="grad-indigo p-2 rounded-lg"><p class="text-xs text-indigo-700 font-semibold">L10 AVG</p><p class="text-lg font-bold text-indigo-800">${s.last10Average.toFixed(1)}</p></div>
                  <div class="grad-pink p-2 rounded-lg"><p class="text-xs text-pink-700 font-semibold">LAST</p><p class="text-sm font-bold text-pink-800">${lastDateInfo ? `${lastDateInfo.text} (${lastDateInfo.days}d)` : 'N/A'}</p></div>
                  <div class="grad-teal p-2 rounded-lg"><p class="text-xs text-teal-700 font-semibold">L10/MAX</p><p class="text-lg font-bold text-teal-800">${pct.toFixed(0)}%</p></div>
                </div>
                ${s.chartData.length > 1 ? `
                  <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="text-xs text-gray-500 font-semibold mb-2">LAST 10 ENTRIES</p>
                    ${renderMiniChart(s.chartData)}
                  </div>
                ` : ''}
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
    `;
  } else {
    html += `
      <div class="card" style="text-align:center;padding:3rem">
        <div class="text-gray-400 mb-4" style="display:flex;justify-content:center">${icon('trend', 64)}</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">No Exercises Yet</h3>
        <p class="text-gray-600">Add your first exercise to start tracking!</p>
      </div>
    `;
  }

  // History
  if (state.records.length > 0) {
    const filteredHistory = getFilteredHistory();
    html += `
      <div class="card">
        <button onclick="state.showHistory=!state.showHistory;render()" class="flex items-center gap-2 text-lg font-bold text-gray-800 bg-white w-full" style="text-align:left">
          <span class="text-indigo-600">${icon('history')}</span>
          Log History (${state.records.length})
          <span class="text-sm text-gray-500 ml-2">${state.showHistory ? '▲' : '▼'}</span>
        </button>
        ${state.showHistory ? `
          <div class="mt-3 mb-3">
            <select value="${state.historyFilter}" onchange="state.historyFilter=this.value;render()" style="font-size:0.875rem">
              <option value="all" ${state.historyFilter === 'all' ? 'selected' : ''}>All Exercises</option>
              ${state.exercises.map(ex => `<option value="${ex.id}" ${state.historyFilter === ex.id ? 'selected' : ''}>${ex.name}</option>`).join('')}
            </select>
          </div>
          <div class="overflow-auto max-h-96">
            ${filteredHistory.map(r => {
              const ex = state.exercises.find(e => e.id === r.exerciseId);
              if (!ex) return '';
              return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-2">
                  <div class="min-w-0 flex-1">
                    <p class="font-medium text-gray-800 truncate">${ex.name}</p>
                    <p class="text-sm text-gray-600">${r.amount} • ${new Date(r.date + 'T00:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</p>
                  </div>
                  <div class="flex gap-1 shrink-0">
                    <button onclick="state.editRecord={...state.records.find(rec=>rec.id==='${r.id}')};render()" class="p-2 text-indigo-600 bg-white rounded-lg">${icon('edit')}</button>
                    <button onclick="state.deleteConfirmId='${r.id}';render()" class="p-2 text-red-600 bg-white rounded-lg">${icon('trash')}</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}
      </div>
    `;
  }

  // Modals
  // Edit Exercise Modal
  if (state.editExercise) {
    html += `
      <div class="fixed inset-0 overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6" style="max-width:24rem;width:100%">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Exercise</h3>
          <div class="mb-3">
            <label class="text-sm font-medium text-gray-600 mb-1" style="display:block">Name</label>
            <input type="text" value="${state.editExercise.name}" oninput="state.editExercise.name=this.value">
          </div>
          <div class="mb-4">
            <label class="text-sm font-medium text-gray-600 mb-1" style="display:block">Daily Goal (optional)</label>
            <input type="number" value="${state.editExercise.goal || ''}" oninput="state.editExercise.goal=this.value?parseFloat(this.value):null" placeholder="e.g., 50">
          </div>
          <div class="flex gap-2 mb-3">
            <button onclick="state.editExercise=null;render()" class="flex-1 p-3 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancel</button>
            <button onclick="updateExercise('${state.editExercise.id}',{name:state.editExercise.name,goal:state.editExercise.goal});state.editExercise=null;render()" class="flex-1 p-3 bg-indigo-600 text-white rounded-lg font-semibold">Save</button>
          </div>
          <button onclick="if(confirm('Delete this exercise and all its records?'))deleteExercise('${state.editExercise.id}')" class="w-full p-3 bg-red-600 text-white rounded-lg font-semibold">Delete Exercise</button>
        </div>
      </div>
    `;
  }

  // Edit Record Modal
  if (state.editRecord) {
    html += `
      <div class="fixed inset-0 overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6" style="max-width:24rem;width:100%">
          <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Log</h3>
          <div class="mb-3">
            <label class="text-sm font-medium text-gray-600 mb-1" style="display:block">Amount</label>
            <input type="number" value="${state.editRecord.amount}" oninput="state.editRecord.amount=parseFloat(this.value)">
          </div>
          <div class="mb-4">
            <label class="text-sm font-medium text-gray-600 mb-1" style="display:block">Date</label>
            <input type="date" value="${state.editRecord.date}" oninput="state.editRecord.date=this.value">
          </div>
          <div class="flex gap-2">
            <button onclick="state.editRecord=null;render()" class="flex-1 p-3 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancel</button>
            <button onclick="updateRecord('${state.editRecord.id}',{amount:state.editRecord.amount,date:state.editRecord.date})" class="flex-1 p-3 bg-indigo-600 text-white rounded-lg font-semibold">Save</button>
          </div>
        </div>
      </div>
    `;
  }

  // Delete Confirm Modal
  if (state.deleteConfirmId) {
    html += `
      <div class="fixed inset-0 overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6" style="max-width:24rem;width:100%">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Log?</h3>
          <p class="text-gray-600 mb-4">This action cannot be undone.</p>
          <div class="flex gap-3">
            <button onclick="state.deleteConfirmId=null;render()" class="flex-1 p-3 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancel</button>
            <button onclick="deleteRecord('${state.deleteConfirmId}')" class="flex-1 p-3 bg-red-600 text-white rounded-lg font-semibold">Delete</button>
          </div>
        </div>
      </div>
    `;
  }

  // Import Modal
  if (state.showImport) {
    html += `
      <div class="fixed inset-0 overlay flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6" style="max-width:32rem;width:100%">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Import CSV</h3>
          <p class="text-gray-600 mb-4">Upload a CSV with columns: Exercise, Date, Amount</p>
          <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-blue-900 font-semibold mb-2">Format:</p>
            <code class="text-xs text-blue-900">Exercise,Date,Amount<br>"Push-ups","2026-01-10",50</code>
          </div>
          <input type="file" accept=".csv" onchange="importData(this.files[0])" class="mb-4 w-full">
          <button onclick="state.showImport=false;render()" class="w-full p-3 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancel</button>
        </div>
      </div>
    `;
  }

  app.innerHTML = html;

  // Auto-focus new exercise input
  if (state.showAddExercise) {
    const input = document.getElementById('newExerciseInput');
    if (input) input.focus();
  }
}

// Initialize
loadState();
render();
</script>
</body>
</html>
