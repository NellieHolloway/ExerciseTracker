<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exercise Tracker</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#eff6ff,#e0e7ff);min-height:100vh}
    .container{max-width:72rem;margin:0 auto;padding:1rem}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);padding:1.5rem;margin-bottom:1.5rem}
    .flex{display:flex}.flex-col{flex-direction:column}.items-center{align-items:center}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.flex-wrap{flex-wrap:wrap}
    .gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}
    .grid{display:grid}.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}.grid-4{grid-template-columns:repeat(4,1fr)}
    .mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}
    .p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}
    .w-full{width:100%}.flex-1{flex:1}
    .text-xs{font-size:0.75rem}.text-sm{font-size:0.875rem}.text-lg{font-size:1.125rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}
    .font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}
    .text-white{color:#fff}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-800{color:#1f2937}
    .text-green-600{color:#16a34a}.text-green-700{color:#15803d}.text-green-800{color:#166534}
    .text-blue-600{color:#2563eb}.text-blue-700{color:#1d4ed8}.text-blue-800{color:#1e40af}
    .text-purple-700{color:#7e22ce}.text-purple-800{color:#6b21a8}
    .text-indigo-600{color:#4f46e5}.text-orange-600{color:#ea580c}.text-red-600{color:#dc2626}.text-red-500{color:#ef4444}.text-red-700{color:#b91c1c}
    .bg-white{background:#fff}.bg-gray-50{background:#f9fafb}.bg-gray-100{background:#f3f4f6}.bg-gray-200{background:#e5e7eb}.bg-red-50{background:#fef2f2}.bg-red-100{background:#fee2e2}
    .bg-green-600{background:#16a34a}.bg-blue-600{background:#2563eb}.bg-indigo-600{background:#4f46e5}.bg-red-600{background:#dc2626}.bg-purple-600{background:#9333ea}
    .grad-green{background:linear-gradient(135deg,#f0fdf4,#dcfce7)}.grad-blue{background:linear-gradient(135deg,#eff6ff,#dbeafe)}
    .grad-purple{background:linear-gradient(135deg,#faf5ff,#f3e8ff)}.grad-orange{background:linear-gradient(135deg,#fff7ed,#ffedd5)}
    .grad-indigo{background:linear-gradient(135deg,#eef2ff,#e0e7ff)}.grad-teal{background:linear-gradient(135deg,#f0fdfa,#ccfbf1)}
    .grad-header{background:linear-gradient(90deg,#6366f1,#9333ea)}
    .rounded{border-radius:0.25rem}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}
    .border{border:1px solid}.border-2{border:2px solid}.border-gray-200{border-color:#e5e7eb}.border-gray-300{border-color:#d1d5db}.border-orange-300{border-color:#fdba74}.border-green-300{border-color:#86efac}.border-red-200{border-color:#fecaca}
    .shadow-2xl{box-shadow:0 25px 50px -12px rgba(0,0,0,0.25)}
    .overflow-auto{overflow:auto}.fixed{position:fixed}.inset-0{top:0;right:0;bottom:0;left:0}.z-50{z-index:50}
    .overlay{background:rgba(0,0,0,0.5)}
    .cursor-pointer{cursor:pointer}
    button{border:none;cursor:pointer;font-family:inherit;transition:all 0.15s}
    button:hover:not(:disabled){filter:brightness(0.92)}
    button:disabled{opacity:0.5;cursor:not-allowed}
    input,select,textarea{font-family:inherit;font-size:1rem;padding:0.5rem 0.75rem;border:2px solid #d1d5db;border-radius:0.5rem;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#6366f1}
    .icon{display:inline-flex;align-items:center;justify-content:center}
    .progress-bar{height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
    .progress-fill{height:100%;border-radius:4px;transition:width 0.3s ease}
    table{width:100%;border-collapse:collapse}
    th,td{padding:0.5rem;text-align:center;border-bottom:1px solid #e5e7eb}
    th{background:#f9fafb;font-weight:600;color:#6b7280;font-size:0.75rem;text-transform:uppercase;position:sticky;top:0}
    td{font-size:0.875rem}
    .exercise-name{text-align:left;font-weight:500;color:#1f2937;white-space:nowrap}
    .week-cell{width:50px;min-width:50px}
    .week-input{width:45px;padding:0.25rem;font-size:0.75rem;text-align:center}
    .freq-badge{font-size:0.65rem;padding:0.125rem 0.375rem;border-radius:9999px;font-weight:600}
    .freq-1x{background:#f3e8ff;color:#7c3aed}
    .freq-2x{background:#dbeafe;color:#1d4ed8}
    .freq-3x{background:#fef3c7;color:#d97706}
    .freq-3x{background:#fef3c7;color:#b45309}
    .complete-row{background:#f0fdf4}
    .complete-cell{color:#16a34a;font-weight:600}
    .section-header{background:#f3f4f6;font-weight:700;color:#4b5563;text-align:left;padding:0.75rem}
    .page-tab{padding:0.75rem 1.5rem;border-radius:0.5rem 0.5rem 0 0;font-weight:600;background:#e5e7eb;color:#4b5563;border:none;margin-right:0.25rem}
    .page-tab.active{background:#fff;color:#4f46e5;box-shadow:0 -2px 10px rgba(0,0,0,0.05)}
    .view-tab{padding:0.5rem 1rem;border-radius:0.5rem;font-weight:500;background:#f3f4f6;color:#4b5563}
    .view-tab.active{background:#4f46e5;color:#fff}
    .nav-btn{padding:0.5rem 1rem;border-radius:0.5rem;font-weight:500;background:#f3f4f6;color:#4b5563}
    .nav-btn:hover{background:#e5e7eb}
    .stat-card{padding:1rem;border-radius:0.75rem;text-align:center}
    .stat-value{font-size:1.5rem;font-weight:700}
    .stat-label{font-size:0.75rem;font-weight:600;text-transform:uppercase;margin-bottom:0.25rem}
    .exercise-row{padding:0.75rem;border-radius:0.5rem;margin-bottom:0.5rem;cursor:pointer;transition:all 0.15s}
    .exercise-row:hover{background:#f3f4f6}
    .exercise-row.selected{background:#eef2ff;border:2px solid #6366f1}
    .mini-chart{display:flex;align-items:flex-end;gap:2px;height:40px}
    .mini-bar{flex:1;background:#6366f1;border-radius:2px 2px 0 0;min-width:4px;transition:height 0.3s}
    @media(max-width:768px){
      .container{padding:0.5rem}
      .card{padding:1rem}
      .hide-mobile{display:none}
      th,td{padding:0.25rem;font-size:0.7rem}
      .week-input{width:35px}
      .grid-4{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
<div class="container" id="app"></div>

<script>
const icons = {
  calendar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
  chart: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>`,
  download: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
  plus: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
  left: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>`,
  right: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>`,
  x: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
};

function icon(name) {
  return `<span class="icon">${icons[name] || ''}</span>`;
}

let state = {
  exercises: [],
  records: [],
  showImport: false,
  showExerciseEditor: false,
  page: 'log', // 'log' or 'stats'
  view: 'weekly', // 'weekly', 'monthly', 'yearly'
  // Date navigation
  selectedWeekStart: null,
  selectedMonth: null, // { year, month }
  selectedYear: null,
  // Stats
  selectedExercise: null,
};

// All exercises
let twiceWeeklyExercises = [
  'Patrick Bateman Sit Ups', 'Pushups', 'Pullups', 'Levitation Squats', 'Squats', 
  'Six Inches', 'Calf Raises', 'Plank', 'Glute Bridge', 'Hindu Pushups',
  'Jumping Jacks', 'Kick Outs', 'Sit ups 60 sec.', 'Side Plank', 'Superman', 
  'Reverse Snow Angels', 'Side to Side Lunges', 'Mountain Climbers', 'Alpine Climbers', 
  'Walking Pushups', 'Tuck Jumps', 'Vsit',
  'Grip Strength Left', 'Grip Strength Right', 'Eyes Closed One Leg Stand', 
  'Weighted Punch', 'Pushups Full', 'Wall Sit', 'Dips', 'Defensive Stance'
];

let onceWeeklyExercises = [
  'Muay Thai', 'Impossible Pushup', 'Arm Hold', 'Butterflys',
  '1 mile', 'Walk 30 min. (vest)', 'Dumbbell Curls', 'Forearm Curls', 
  'Tricep Extention', 'Shoulder Shrugs', 'Murph'
];

let thriceWeeklyExercises = [];

function getAllExercises() {
  return [...new Set([...twiceWeeklyExercises, ...onceWeeklyExercises, ...thriceWeeklyExercises])];
}

function getExerciseFrequency(name) {
  if (thriceWeeklyExercises.includes(name)) return 3;
  if (twiceWeeklyExercises.includes(name)) return 2;
  if (onceWeeklyExercises.includes(name)) return 1;
  return 2; // default
}

function loadState() {
  try {
    const e = localStorage.getItem('ex_exercises');
    const r = localStorage.getItem('ex_records');
    if (e) state.exercises = JSON.parse(e);
    if (r) state.records = JSON.parse(r);
  } catch (err) { console.log(err); }
  
  // Initialize date selections
  const now = getNYDate();
  state.selectedWeekStart = getWeekStartDate(now);
  state.selectedMonth = { year: now.getFullYear(), month: now.getMonth() };
  state.selectedYear = now.getFullYear();
}

function saveExercises() { localStorage.setItem('ex_exercises', JSON.stringify(state.exercises)); }
function saveRecords() { localStorage.setItem('ex_records', JSON.stringify(state.records)); }

function getNYDate() {
  return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
}

function todayStr() {
  return new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
}

function getWeekStartDate(date) {
  const d = new Date(date);
  d.setDate(d.getDate() - d.getDay());
  d.setHours(0, 0, 0, 0);
  return d;
}

function getWeekDatesFrom(startDate) {
  const dates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);
    dates.push(d.toISOString().split('T')[0]);
  }
  return dates;
}

function getMonthWeeksFrom(year, month) {
  const weeks = [];
  let current = new Date(year, month, 1);
  current.setDate(current.getDate() - current.getDay());
  
  while (current.getMonth() <= month || (month === 11 && current.getMonth() === 0)) {
    const weekStart = new Date(current);
    const weekEnd = new Date(current);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    if (weekEnd.getMonth() === month || weekStart.getMonth() === month) {
      weeks.push({
        start: weekStart.toISOString().split('T')[0],
        end: weekEnd.toISOString().split('T')[0],
        label: `${weekStart.getMonth()+1}/${weekStart.getDate()}`
      });
    }
    
    current.setDate(current.getDate() + 7);
    if (current.getMonth() > month && current.getFullYear() >= year) break;
    if (weeks.length > 6) break;
  }
  return weeks;
}

function getYearMonthsFrom(year) {
  const months = [];
  for (let m = 0; m < 12; m++) {
    const start = new Date(year, m, 1);
    const end = new Date(year, m + 1, 0);
    months.push({
      start: start.toISOString().split('T')[0],
      end: end.toISOString().split('T')[0],
      label: start.toLocaleDateString('en-US', { month: 'short' })
    });
  }
  return months;
}

function findExerciseByName(name) {
  return state.exercises.find(ex => ex.name.toLowerCase() === name.toLowerCase());
}

function ensureExerciseExists(name) {
  let ex = findExerciseByName(name);
  if (!ex) {
    ex = { id: Date.now().toString() + Math.random(), name, createdAt: new Date().toISOString(), goal: null };
    state.exercises.push(ex);
    saveExercises();
  }
  return ex;
}

function getRecordForDate(exerciseId, dateStr) {
  return state.records.find(r => r.exerciseId === exerciseId && r.date === dateStr);
}

function getRecordsInRange(exerciseId, startDate, endDate) {
  return state.records.filter(r => r.exerciseId === exerciseId && r.date >= startDate && r.date <= endDate);
}

function getCountInRange(exerciseId, startDate, endDate) {
  return getRecordsInRange(exerciseId, startDate, endDate).length;
}

function getWeeklyCountFrom(exerciseId, weekStart) {
  const dates = getWeekDatesFrom(weekStart);
  return state.records.filter(r => r.exerciseId === exerciseId && dates.includes(r.date)).length;
}

function getExerciseStats(exerciseId) {
  const recs = state.records.filter(r => r.exerciseId === exerciseId).sort((a, b) => new Date(b.date) - new Date(a.date));
  if (!recs.length) return { max: 0, min: 0, avg: 0, total: 0, count: 0, last7Avg: 0, l7MaxRatio: 0, stdDev: 0, median: 0, recentTrend: 0, bestDay: null, firstDate: null, lastDate: null };
  
  const amounts = recs.map(r => r.amount);
  const max = Math.max(...amounts);
  const min = Math.min(...amounts);
  const total = amounts.reduce((a, b) => a + b, 0);
  const avg = total / amounts.length;
  const count = recs.length;
  
  const last7 = recs.slice(0, 7);
  const last7Avg = last7.reduce((sum, r) => sum + r.amount, 0) / last7.length;
  const l7MaxRatio = max > 0 ? (last7Avg / max) * 100 : 0;
  
  // Standard deviation
  const squareDiffs = amounts.map(a => Math.pow(a - avg, 2));
  const stdDev = Math.sqrt(squareDiffs.reduce((a, b) => a + b, 0) / amounts.length);
  
  // Median
  const sorted = [...amounts].sort((a, b) => a - b);
  const median = sorted.length % 2 === 0 ? (sorted[sorted.length/2 - 1] + sorted[sorted.length/2]) / 2 : sorted[Math.floor(sorted.length/2)];
  
  // Recent trend (last 7 vs previous 7)
  const prev7 = recs.slice(7, 14);
  const prev7Avg = prev7.length > 0 ? prev7.reduce((sum, r) => sum + r.amount, 0) / prev7.length : 0;
  const recentTrend = prev7Avg > 0 ? ((last7Avg - prev7Avg) / prev7Avg) * 100 : 0;
  
  // Best day of week
  const dayTotals = [0,0,0,0,0,0,0];
  const dayCounts = [0,0,0,0,0,0,0];
  recs.forEach(r => {
    const day = new Date(r.date + 'T00:00:00').getDay();
    dayTotals[day] += r.amount;
    dayCounts[day]++;
  });
  const dayAvgs = dayTotals.map((t, i) => dayCounts[i] > 0 ? t / dayCounts[i] : 0);
  const bestDayIdx = dayAvgs.indexOf(Math.max(...dayAvgs));
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  return {
    max, min, avg, total, count, last7Avg, l7MaxRatio, stdDev, median, recentTrend,
    bestDay: dayNames[bestDayIdx],
    firstDate: recs[recs.length - 1].date,
    lastDate: recs[0].date,
    chartData: recs.slice(0, 30).reverse()
  };
}

function getOverallStats() {
  const allExercises = getAllExercises();
  const weekDates = getWeekDatesFrom(state.selectedWeekStart);
  const today = todayStr();
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  // Total records
  const totalRecords = state.records.length;
  const totalExercises = allExercises.length;
  
  // This week's stats
  const thisWeekRecords = state.records.filter(r => weekDates.includes(r.date));
  const thisWeekCount = thisWeekRecords.length;
  const thisWeekTotal = thisWeekRecords.reduce((sum, r) => sum + r.amount, 0);
  
  // Today's stats
  const todayRecords = state.records.filter(r => r.date === today);
  const todayCount = todayRecords.length;
  
  // Most done exercise (by count)
  const exerciseCounts = {};
  state.records.forEach(r => {
    exerciseCounts[r.exerciseId] = (exerciseCounts[r.exerciseId] || 0) + 1;
  });
  let mostDoneId = null, mostDoneCount = 0;
  Object.entries(exerciseCounts).forEach(([id, count]) => {
    if (count > mostDoneCount) { mostDoneId = id; mostDoneCount = count; }
  });
  const mostDoneExercise = mostDoneId ? state.exercises.find(e => e.id === mostDoneId) : null;
  
  // Least done exercise (that exists and has been done at least once)
  let leastDoneId = null, leastDoneCount = Infinity;
  Object.entries(exerciseCounts).forEach(([id, count]) => {
    if (count < leastDoneCount) { leastDoneId = id; leastDoneCount = count; }
  });
  const leastDoneExercise = leastDoneId ? state.exercises.find(e => e.id === leastDoneId) : null;
  
  // Exercise to do now (not done this week, or done least relative to target)
  let shouldDoNow = null;
  let lowestCompletion = Infinity;
  allExercises.forEach(name => {
    const ex = findExerciseByName(name);
    if (!ex) return;
    const freq = getExerciseFrequency(name);
    const weekCount = state.records.filter(r => r.exerciseId === ex.id && weekDates.includes(r.date)).length;
    const completion = weekCount / freq;
    if (completion < lowestCompletion && completion < 1) {
      lowestCompletion = completion;
      shouldDoNow = name;
    }
  });
  
  // Best day of week (most exercises done)
  const dayTotals = [0,0,0,0,0,0,0];
  state.records.forEach(r => {
    const day = new Date(r.date + 'T00:00:00').getDay();
    dayTotals[day]++;
  });
  const bestDayIdx = dayTotals.indexOf(Math.max(...dayTotals));
  const worstDayIdx = dayTotals.indexOf(Math.min(...dayTotals.filter(d => d > 0) || [0]));
  
  // Streak - consecutive days with at least one exercise
  let currentStreak = 0;
  let d = new Date(today);
  while (true) {
    const dateStr = d.toISOString().split('T')[0];
    if (state.records.some(r => r.date === dateStr)) {
      currentStreak++;
      d.setDate(d.getDate() - 1);
    } else {
      break;
    }
  }
  
  // Longest streak
  const allDates = [...new Set(state.records.map(r => r.date))].sort();
  let longestStreak = 0, tempStreak = 1;
  for (let i = 1; i < allDates.length; i++) {
    const prev = new Date(allDates[i-1]);
    const curr = new Date(allDates[i]);
    const diff = (curr - prev) / (1000 * 60 * 60 * 24);
    if (diff === 1) {
      tempStreak++;
    } else {
      longestStreak = Math.max(longestStreak, tempStreak);
      tempStreak = 1;
    }
  }
  longestStreak = Math.max(longestStreak, tempStreak);
  
  // Completion rate this week
  let expectedThisWeek = 0;
  let completedThisWeek = 0;
  allExercises.forEach(name => {
    const freq = getExerciseFrequency(name);
    expectedThisWeek += freq;
    const ex = findExerciseByName(name);
    if (ex) {
      completedThisWeek += Math.min(state.records.filter(r => r.exerciseId === ex.id && weekDates.includes(r.date)).length, freq);
    }
  });
  const weeklyCompletionRate = expectedThisWeek > 0 ? (completedThisWeek / expectedThisWeek) * 100 : 0;
  
  // Average exercises per day (all time)
  const uniqueDays = new Set(state.records.map(r => r.date)).size;
  const avgPerDay = uniqueDays > 0 ? totalRecords / uniqueDays : 0;
  
  // Exercises never done
  const neverDone = allExercises.filter(name => {
    const ex = findExerciseByName(name);
    return !ex || !state.records.some(r => r.exerciseId === ex.id);
  });
  
  // Recent activity (last 7 days counts)
  const last7Days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const count = state.records.filter(r => r.date === dateStr).length;
    last7Days.push({ date: dateStr, count, dayName: dayNames[d.getDay()].slice(0, 3) });
  }
  
  return {
    totalRecords,
    totalExercises,
    thisWeekCount,
    thisWeekTotal,
    todayCount,
    mostDoneExercise: mostDoneExercise?.name,
    mostDoneCount,
    leastDoneExercise: leastDoneExercise?.name,
    leastDoneCount,
    shouldDoNow,
    bestDay: dayNames[bestDayIdx],
    worstDay: dayNames[worstDayIdx],
    currentStreak,
    longestStreak,
    weeklyCompletionRate,
    completedThisWeek,
    expectedThisWeek,
    avgPerDay,
    neverDone,
    uniqueDays,
    last7Days
  };
}

function getAllExercisesOverviewStats() {
  const allEx = getAllExercises();
  const weekDates = getWeekDatesFrom(state.selectedWeekStart);
  const today = todayStr();
  
  // Total logs
  const totalLogs = state.records.length;
  
  // Unique exercises logged
  const loggedExerciseIds = [...new Set(state.records.map(r => r.exerciseId))];
  const uniqueExercisesLogged = loggedExerciseIds.length;
  
  // This week stats
  const thisWeekLogs = state.records.filter(r => weekDates.includes(r.date)).length;
  
  // Today stats
  const todayLogs = state.records.filter(r => r.date === today).length;
  
  // Most done exercise (by count)
  const exerciseCounts = {};
  state.records.forEach(r => {
    exerciseCounts[r.exerciseId] = (exerciseCounts[r.exerciseId] || 0) + 1;
  });
  let mostDoneExercise = null;
  let mostDoneCount = 0;
  Object.entries(exerciseCounts).forEach(([id, count]) => {
    if (count > mostDoneCount) {
      mostDoneCount = count;
      const ex = state.exercises.find(e => e.id === id);
      if (ex) mostDoneExercise = ex.name;
    }
  });
  
  // Least done exercise (that has at least 1 log)
  let leastDoneExercise = null;
  let leastDoneCount = Infinity;
  Object.entries(exerciseCounts).forEach(([id, count]) => {
    if (count < leastDoneCount) {
      leastDoneCount = count;
      const ex = state.exercises.find(e => e.id === id);
      if (ex) leastDoneExercise = ex.name;
    }
  });
  if (leastDoneCount === Infinity) leastDoneCount = 0;
  
  // Exercise you should do right now (incomplete this week, prioritize by how far behind)
  const shouldDoNow = [];
  allEx.forEach(name => {
    const ex = findExerciseByName(name);
    const freq = getExerciseFrequency(name);
    const weekCount = ex ? state.records.filter(r => r.exerciseId === ex.id && weekDates.includes(r.date)).length : 0;
    const remaining = freq - weekCount;
    if (remaining > 0) {
      shouldDoNow.push({ name, remaining, freq, weekCount });
    }
  });
  shouldDoNow.sort((a, b) => b.remaining - a.remaining || a.name.localeCompare(b.name));
  
  // Current streak (consecutive days with at least 1 log)
  let currentStreak = 0;
  const checkDate = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
  while (true) {
    const dateStr = checkDate.toISOString().split('T')[0];
    const hasLog = state.records.some(r => r.date === dateStr);
    if (hasLog) {
      currentStreak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else {
      break;
    }
  }
  
  // Best day of week overall
  const dayTotals = [0,0,0,0,0,0,0];
  state.records.forEach(r => {
    const day = new Date(r.date + 'T00:00:00').getDay();
    dayTotals[day]++;
  });
  const bestDayIdx = dayTotals.indexOf(Math.max(...dayTotals));
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  
  // Average logs per day (days with at least 1 log)
  const uniqueDays = [...new Set(state.records.map(r => r.date))];
  const avgLogsPerDay = uniqueDays.length > 0 ? totalLogs / uniqueDays.length : 0;
  
  // Weekly completion rate
  const weeklyProgress = getWeeklyProgress();
  const completionRate = weeklyProgress.total > 0 ? (weeklyProgress.done / weeklyProgress.total) * 100 : 0;
  
  // First and last log dates
  const sortedRecords = [...state.records].sort((a, b) => new Date(a.date) - new Date(b.date));
  const firstLogDate = sortedRecords.length > 0 ? sortedRecords[0].date : null;
  const lastLogDate = sortedRecords.length > 0 ? sortedRecords[sortedRecords.length - 1].date : null;
  
  // Days since started
  const daysSinceStart = firstLogDate ? Math.floor((new Date() - new Date(firstLogDate)) / (1000 * 60 * 60 * 24)) : 0;
  
  return {
    totalLogs,
    uniqueExercisesLogged,
    totalExercises: allEx.length,
    thisWeekLogs,
    todayLogs,
    mostDoneExercise,
    mostDoneCount,
    leastDoneExercise,
    leastDoneCount,
    shouldDoNow: shouldDoNow.slice(0, 5),
    currentStreak,
    bestDay: dayNames[bestDayIdx],
    avgLogsPerDay,
    completionRate,
    firstLogDate,
    lastLogDate,
    daysSinceStart,
    uniqueDays: uniqueDays.length
  };
}

function getWeeklyProgress() {
  const weekDates = getWeekDatesFrom(state.selectedWeekStart);
  let done = 0, total = 0;
  
  getAllExercises().forEach(name => {
    const ex = findExerciseByName(name);
    const freq = getExerciseFrequency(name);
    total += freq;
    if (ex) {
      done += Math.min(state.records.filter(r => r.exerciseId === ex.id && weekDates.includes(r.date)).length, freq);
    }
  });
  
  return { done, total };
}

// Navigation
function prevPeriod() {
  if (state.view === 'weekly') {
    state.selectedWeekStart = new Date(state.selectedWeekStart.getTime() - 7 * 24 * 60 * 60 * 1000);
  } else if (state.view === 'monthly') {
    state.selectedMonth.month--;
    if (state.selectedMonth.month < 0) { state.selectedMonth.month = 11; state.selectedMonth.year--; }
  } else {
    state.selectedYear--;
  }
  render();
}

function nextPeriod() {
  if (state.view === 'weekly') {
    state.selectedWeekStart = new Date(state.selectedWeekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
  } else if (state.view === 'monthly') {
    state.selectedMonth.month++;
    if (state.selectedMonth.month > 11) { state.selectedMonth.month = 0; state.selectedMonth.year++; }
  } else {
    state.selectedYear++;
  }
  render();
}

function goToToday() {
  const now = getNYDate();
  state.selectedWeekStart = getWeekStartDate(now);
  state.selectedMonth = { year: now.getFullYear(), month: now.getMonth() };
  state.selectedYear = now.getFullYear();
  render();
}

// Actions
function logFromInput(exerciseName, dateStr, inputId) {
  const input = document.getElementById(inputId);
  if (!input || !input.value || isNaN(parseFloat(input.value))) return;
  
  const ex = ensureExerciseExists(exerciseName);
  const existing = getRecordForDate(ex.id, dateStr);
  
  if (existing) { existing.amount = parseFloat(input.value); }
  else { state.records.push({ id: Date.now().toString() + Math.random(), exerciseId: ex.id, amount: parseFloat(input.value), date: dateStr, timestamp: new Date().toISOString() }); }
  
  saveRecords();
  render();
}

function logAllFilled() {
  const weekDates = getWeekDatesFrom(state.selectedWeekStart);
  let logged = 0;
  
  getAllExercises().forEach(name => {
    weekDates.forEach((dateStr, i) => {
      const inputId = `input-${name.replace(/[^a-zA-Z0-9]/g, '-')}-${i}`;
      const input = document.getElementById(inputId);
      if (input && input.value && !isNaN(parseFloat(input.value))) {
        const ex = ensureExerciseExists(name);
        const existing = getRecordForDate(ex.id, dateStr);
        if (existing) { existing.amount = parseFloat(input.value); }
        else { state.records.push({ id: Date.now().toString() + Math.random(), exerciseId: ex.id, amount: parseFloat(input.value), date: dateStr, timestamp: new Date().toISOString() }); }
        logged++;
      }
    });
  });
  
  if (logged > 0) { saveRecords(); render(); }
}

function addAllExercises() {
  let added = 0;
  getAllExercises().forEach(name => {
    if (!findExerciseByName(name)) {
      state.exercises.push({ id: Date.now().toString() + Math.random(), name, createdAt: new Date().toISOString(), goal: null });
      added++;
    }
  });
  if (added > 0) { saveExercises(); render(); alert(`Added ${added} exercises!`); }
  else { alert('All exercises already exist.'); }
}

function clearAllData() {
  if (confirm('Clear ALL data?')) {
    state.exercises = []; state.records = [];
    saveExercises(); saveRecords(); render();
  }
}

function openExerciseEditor() {
  state.showExerciseEditor = true;
  render();
}

function closeExerciseEditor() {
  state.showExerciseEditor = false;
  render();
}

function addSingleExercise(name, freq) {
  if (!name.trim()) return;
  const trimmed = name.trim();
  if (findExerciseByName(trimmed)) {
    alert('Exercise already exists!');
    return;
  }
  
  state.exercises.push({
    id: Date.now().toString() + Math.random(),
    name: trimmed,
    createdAt: new Date().toISOString(),
    goal: null,
    frequency: freq || 2
  });
  
  // Add to appropriate array
  if (freq === 1 && !onceWeeklyExercises.includes(trimmed)) {
    onceWeeklyExercises.push(trimmed);
  } else if (freq === 3 && !thriceWeeklyExercises.includes(trimmed)) {
    thriceWeeklyExercises.push(trimmed);
  } else if (!twiceWeeklyExercises.includes(trimmed)) {
    twiceWeeklyExercises.push(trimmed);
  }
  
  saveExercises();
  render();
}

function addBulkExercises(text, freq) {
  if (!text.trim()) return;
  const names = text.split('\n').map(n => n.trim()).filter(n => n);
  const allEx = getAllExercises();
  let added = 0;
  
  names.forEach(name => {
    if (!findExerciseByName(name) && !allEx.includes(name)) {
      state.exercises.push({
        id: Date.now().toString() + Math.random(),
        name: name,
        createdAt: new Date().toISOString(),
        goal: null,
        frequency: freq
      });
      
      if (freq === 1) {
        onceWeeklyExercises.push(name);
      } else if (freq === 3) {
        thriceWeeklyExercises.push(name);
      } else {
        twiceWeeklyExercises.push(name);
      }
      added++;
    }
  });
  
  if (added > 0) {
    saveExercises();
    render();
    alert(`Added ${added} exercise${added > 1 ? 's' : ''}!`);
  } else {
    alert('No new exercises to add (all already exist).');
  }
}

function removeExercise(name) {
  if (!confirm(`Remove "${name}" and all its records?`)) return;
  
  const ex = findExerciseByName(name);
  if (ex) {
    state.exercises = state.exercises.filter(e => e.id !== ex.id);
    state.records = state.records.filter(r => r.exerciseId !== ex.id);
  }
  
  // Remove from arrays
  const twiceIdx = twiceWeeklyExercises.indexOf(name);
  if (twiceIdx > -1) twiceWeeklyExercises.splice(twiceIdx, 1);
  
  const onceIdx = onceWeeklyExercises.indexOf(name);
  if (onceIdx > -1) onceWeeklyExercises.splice(onceIdx, 1);
  
  const thriceIdx = thriceWeeklyExercises.indexOf(name);
  if (thriceIdx > -1) thriceWeeklyExercises.splice(thriceIdx, 1);
  
  saveExercises();
  saveRecords();
  render();
}

function changeFrequency(name, newFreq) {
  const ex = findExerciseByName(name);
  if (ex) {
    ex.frequency = newFreq;
    saveExercises();
  }
  
  // Remove from all arrays first
  const twiceIdx = twiceWeeklyExercises.indexOf(name);
  if (twiceIdx > -1) twiceWeeklyExercises.splice(twiceIdx, 1);
  
  const onceIdx = onceWeeklyExercises.indexOf(name);
  if (onceIdx > -1) onceWeeklyExercises.splice(onceIdx, 1);
  
  const thriceIdx = thriceWeeklyExercises.indexOf(name);
  if (thriceIdx > -1) thriceWeeklyExercises.splice(thriceIdx, 1);
  
  // Add to correct array
  if (newFreq === 1) {
    onceWeeklyExercises.push(name);
  } else if (newFreq === 3) {
    thriceWeeklyExercises.push(name);
  } else {
    twiceWeeklyExercises.push(name);
  }
  
  render();
}

function downloadData() {
  let csv = 'Exercise,Date,Amount\n';
  state.records.forEach(r => {
    const ex = state.exercises.find(e => e.id === r.exerciseId);
    if (ex) csv += `"${ex.name}","${r.date}",${r.amount}\n`;
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `exercise-tracker-${todayStr()}.csv`;
  a.click();
}

function importData(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const lines = ev.target.result.split('\n').slice(1).filter(l => l.trim());
      let imported = 0;
      lines.forEach(line => {
        const m = line.match(/("([^"]*)"|[^,]+)/g);
        if (!m || m.length < 3) return;
        const name = m[0].replace(/^"|"$/g, '').trim();
        const date = m[1].replace(/^"|"$/g, '').trim();
        const amt = parseFloat(m[2].replace(/^"|"$/g, '').trim());
        if (!name || !date || isNaN(amt)) return;
        const ex = ensureExerciseExists(name);
        if (!getRecordForDate(ex.id, date)) {
          state.records.push({ id: Date.now().toString() + Math.random(), exerciseId: ex.id, amount: amt, date, timestamp: new Date().toISOString() });
          imported++;
        }
      });
      saveExercises(); saveRecords(); state.showImport = false;
      alert(`Imported ${imported} records!`); render();
    } catch (err) { alert('Error importing CSV'); }
  };
  reader.readAsText(file);
}

function selectExercise(name) {
  state.selectedExercise = name;
  render();
}

// Render
function render() {
  const app = document.getElementById('app');
  
  let html = `
    <!-- Page Tabs -->
    <div class="flex mb-0">
      <button onclick="state.page='log';render()" class="page-tab ${state.page === 'log' ? 'active' : ''}">${icon('calendar')} Log</button>
      <button onclick="state.page='stats';render()" class="page-tab ${state.page === 'stats' ? 'active' : ''}">${icon('chart')} Stats</button>
    </div>
  `;
  
  if (state.page === 'log') {
    html += renderLogPage();
  } else {
    html += renderStatsPage();
  }
  
  // Import Modal
  if (state.showImport) {
    html += `
      <div class="fixed inset-0 overlay z-50" style="display:flex;align-items:center;justify-content:center">
        <div class="bg-white rounded-xl shadow-2xl p-6" style="max-width:32rem;width:100%">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Import CSV</h3>
          <p class="text-gray-600 mb-4">Format: Exercise, Date, Amount</p>
          <input type="file" accept=".csv" onchange="importData(this.files[0])" class="mb-4 w-full">
          <button onclick="state.showImport=false;render()" class="w-full p-3 bg-gray-200 text-gray-800 rounded-lg font-semibold">Cancel</button>
        </div>
      </div>
    `;
  }
  
  // Exercise Editor Modal
  if (state.showExerciseEditor) {
    const sortedExercises = getAllExercises().slice().sort((a, b) => a.localeCompare(b));
    html += `
      <div class="fixed inset-0 overlay z-50" style="display:flex;align-items:center;justify-content:center;padding:1rem">
        <div class="bg-white rounded-xl shadow-2xl" style="max-width:56rem;width:100%;max-height:90vh;display:flex;flex-direction:column">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-bold text-gray-800">Exercise Editor</h3>
              <button onclick="closeExerciseEditor()" class="text-gray-500 p-2">${icon('x')}</button>
            </div>
          </div>
          
          <div class="p-6 overflow-auto flex-1">
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:1.5rem">
              <!-- Add Exercises -->
              <div>
                <h4 class="font-bold text-gray-800 mb-3">Add Single Exercise</h4>
                <div class="flex gap-2 mb-4">
                  <input type="text" id="newExerciseName" placeholder="Exercise name" class="flex-1">
                  <select id="newExerciseFreq" style="width:80px">
                    <option value="1">1x</option>
                    <option value="2" selected>2x</option>
                    <option value="3">3x</option>
                  </select>
                  <button onclick="addSingleExercise(document.getElementById('newExerciseName').value, parseInt(document.getElementById('newExerciseFreq').value));document.getElementById('newExerciseName').value=''" class="bg-green-600 text-white px-3 rounded-lg font-medium">Add</button>
                </div>
                
                <h4 class="font-bold text-gray-800 mb-3">Add Multiple Exercises</h4>
                <p class="text-sm text-gray-500 mb-2">One exercise per line</p>
                <textarea id="bulkExercises" rows="6" class="w-full mb-2" style="resize:vertical" placeholder="Pushups&#10;Pullups&#10;Squats"></textarea>
                <div class="flex gap-2">
                  <select id="bulkFreq" style="width:100px">
                    <option value="1">1x/week</option>
                    <option value="2" selected>2x/week</option>
                    <option value="3">3x/week</option>
                  </select>
                  <button onclick="addBulkExercises(document.getElementById('bulkExercises').value, parseInt(document.getElementById('bulkFreq').value));document.getElementById('bulkExercises').value=''" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium flex-1">Add All</button>
                </div>
                
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                  <p class="text-sm text-gray-600"><strong>Total Exercises:</strong> ${getAllExercises().length}</p>
                  <p class="text-xs text-gray-500 mt-1">1x: ${onceWeeklyExercises.length} | 2x: ${twiceWeeklyExercises.length} | 3x: ${thriceWeeklyExercises.length}</p>
                </div>
              </div>
              
              <!-- Current Exercises -->
              <div>
                <h4 class="font-bold text-gray-800 mb-3">Current Exercises (${getAllExercises().length})</h4>
                <div style="max-height:400px;overflow-y:auto" class="border border-gray-200 rounded-lg">
                  ${sortedExercises.length > 0 ? sortedExercises.map(name => {
                    const ex = findExerciseByName(name);
                    const recCount = ex ? state.records.filter(r => r.exerciseId === ex.id).length : 0;
                    const freq = getExerciseFrequency(name);
                    const freqClass = freq === 1 ? 'freq-1x' : freq === 3 ? 'freq-3x' : 'freq-2x';
                    return `
                      <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50">
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                          <span class="font-medium text-gray-800 truncate">${name}</span>
                          ${recCount > 0 ? `<span class="text-xs text-gray-400">(${recCount} logs)</span>` : ''}
                        </div>
                        <div class="flex items-center gap-2 shrink-0">
                          <select onchange="changeFrequency('${name.replace(/'/g, "\\'")}', parseInt(this.value))" style="width:70px;padding:0.25rem;font-size:0.75rem">
                            <option value="1" ${freq === 1 ? 'selected' : ''}>1x</option>
                            <option value="2" ${freq === 2 ? 'selected' : ''}>2x</option>
                            <option value="3" ${freq === 3 ? 'selected' : ''}>3x</option>
                          </select>
                          <button onclick="removeExercise('${name.replace(/'/g, "\\'")}')" class="text-red-600 p-1 hover:bg-red-50 rounded" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                          </button>
                        </div>
                      </div>
                    `;
                  }).join('') : '<p class="p-4 text-gray-500 text-center">No exercises yet</p>'}
                </div>
              </div>
            </div>
          </div>
          
          <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-xl">
            <button onclick="closeExerciseEditor()" class="w-full p-3 bg-indigo-600 text-white rounded-lg font-semibold">Done</button>
          </div>
        </div>
      </div>
    `;
  }
  
  app.innerHTML = html;
}

function renderLogPage() {
  const today = todayStr();
  const weekProgress = getWeeklyProgress();
  
  return `
    <div class="card" style="border-radius:0 1rem 1rem 1rem">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Exercise Log</h1>
          <p class="text-gray-500 text-sm">${getViewLabel()}</p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button onclick="addAllExercises()" class="bg-green-600 text-white p-2 px-3 rounded-lg font-medium text-sm">${icon('plus')} Add All</button>
          <button onclick="openExerciseEditor()" class="bg-purple-600 text-white p-2 px-3 rounded-lg font-medium text-sm">Edit</button>
          <button onclick="clearAllData()" class="bg-red-600 text-white p-2 px-3 rounded-lg font-medium text-sm">Clear</button>
          <button onclick="downloadData()" class="bg-blue-600 text-white p-2 px-3 rounded-lg font-medium text-sm">${icon('download')}</button>
          <button onclick="state.showImport=true;render()" class="bg-indigo-600 text-white p-2 px-3 rounded-lg font-medium text-sm">${icon('plus')} Import</button>
        </div>
      </div>
      
      <!-- View Tabs + Navigation -->
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
        <div class="flex gap-2">
          <button onclick="state.view='weekly';render()" class="view-tab ${state.view === 'weekly' ? 'active' : ''}">Weekly</button>
          <button onclick="state.view='monthly';render()" class="view-tab ${state.view === 'monthly' ? 'active' : ''}">Monthly</button>
          <button onclick="state.view='yearly';render()" class="view-tab ${state.view === 'yearly' ? 'active' : ''}">Yearly</button>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="prevPeriod()" class="nav-btn">${icon('left')}</button>
          <button onclick="goToToday()" class="nav-btn">Today</button>
          <button onclick="nextPeriod()" class="nav-btn">${icon('right')}</button>
        </div>
      </div>
      
      <!-- Progress -->
      <div class="p-3 rounded-lg grad-blue mb-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-blue-700 font-semibold mb-1">WEEKLY PROGRESS</p>
            <p class="text-xl font-bold text-blue-800">${weekProgress.done} / ${weekProgress.total}</p>
          </div>
          <div class="text-right">
            <p class="text-2xl font-bold text-blue-800">${weekProgress.total > 0 ? Math.round((weekProgress.done/weekProgress.total)*100) : 0}%</p>
          </div>
        </div>
        <div class="progress-bar mt-2"><div class="progress-fill" style="width:${weekProgress.total > 0 ? (weekProgress.done/weekProgress.total)*100 : 0}%;background:#2563eb"></div></div>
      </div>
      
      <!-- Table -->
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-bold text-gray-800">${state.view.charAt(0).toUpperCase() + state.view.slice(1)} View</h2>
        ${state.view === 'weekly' ? `<button onclick="logAllFilled()" class="bg-indigo-600 text-white p-2 px-4 rounded-lg font-medium text-sm">Log All</button>` : ''}
      </div>
      
      <div class="overflow-auto" style="max-height:60vh">
        ${state.view === 'weekly' ? renderWeeklyTable(today) : ''}
        ${state.view === 'monthly' ? renderMonthlyTable() : ''}
        ${state.view === 'yearly' ? renderYearlyTable() : ''}
      </div>
    </div>
  `;
}

function getViewLabel() {
  if (state.view === 'weekly') {
    const end = new Date(state.selectedWeekStart);
    end.setDate(end.getDate() + 6);
    return `${state.selectedWeekStart.toLocaleDateString('en-US', {month:'short',day:'numeric'})} - ${end.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})}`;
  } else if (state.view === 'monthly') {
    return new Date(state.selectedMonth.year, state.selectedMonth.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  } else {
    return state.selectedYear.toString();
  }
}

function renderWeeklyTable(today) {
  const weekDates = getWeekDatesFrom(state.selectedWeekStart);
  const allEx = getAllExercises();
  
  // Combine all exercises with their completion status
  const exercisesWithStatus = allEx.map(name => {
    const ex = findExerciseByName(name);
    const target = getExerciseFrequency(name);
    const weekCount = ex ? getWeeklyCountFrom(ex.id, state.selectedWeekStart) : 0;
    const isComplete = weekCount >= target;
    return { name, target, isComplete };
  });
  
  // Sort: incomplete first (alphabetically), then complete (alphabetically)
  const incomplete = exercisesWithStatus.filter(e => !e.isComplete).sort((a, b) => a.name.localeCompare(b.name));
  const complete = exercisesWithStatus.filter(e => e.isComplete).sort((a, b) => a.name.localeCompare(b.name));
  const sortedExercises = [...incomplete, ...complete];
  
  let html = `<table><thead><tr>
    <th style="text-align:left;min-width:160px">Exercise</th>
    <th class="week-cell">Freq</th>
    ${weekDates.map((d, i) => `<th class="week-cell" style="background:${d===today?'#dbeafe':''}">${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][i]}<br><span style="font-weight:400;font-size:0.6rem">${d.slice(5)}</span></th>`).join('')}
    <th class="week-cell">Done</th>
  </tr></thead><tbody>`;
  
  sortedExercises.forEach(({ name, target }) => {
    html += renderWeeklyRow(name, target, weekDates, today);
  });
  
  return html + `</tbody></table>`;
}

function renderWeeklyRow(name, target, weekDates, today) {
  const ex = findExerciseByName(name);
  const weekCount = ex ? getWeeklyCountFrom(ex.id, state.selectedWeekStart) : 0;
  const isComplete = weekCount >= target;
  const inputBase = name.replace(/[^a-zA-Z0-9]/g, '-');
  
  const freqClass = target === 1 ? 'freq-1x' : target === 3 ? 'freq-3x' : 'freq-2x';
  
  let cells = weekDates.map((d, i) => {
    const rec = ex ? getRecordForDate(ex.id, d) : null;
    const inputId = `input-${inputBase}-${i}`;
    const escaped = name.replace(/'/g, "\\'");
    return `<td class="week-cell" style="background:${d===today?'#eff6ff':''}">
      ${rec ? `<span class="complete-cell">${rec.amount}</span>` : `<input type="number" id="${inputId}" class="week-input" placeholder="-" onkeypress="if(event.key==='Enter')logFromInput('${escaped}','${d}','${inputId}')">`}
    </td>`;
  }).join('');
  
  return `<tr class="${isComplete ? 'complete-row' : ''}">
    <td class="exercise-name">${isComplete ? '✓ ' : ''}${name}</td>
    <td><span class="freq-badge ${freqClass}">${target}x</span></td>
    ${cells}
    <td><span class="freq-badge" style="${isComplete ? 'background:#dcfce7;color:#166534' : ''}">${weekCount}/${target}</span></td>
  </tr>`;
}

function renderMonthlyTable() {
  const weeks = getMonthWeeksFrom(state.selectedMonth.year, state.selectedMonth.month);
  const allEx = getAllExercises();
  
  // Combine and sort alphabetically
  const sortedExercises = allEx.map(name => ({
    name,
    target: getExerciseFrequency(name)
  })).sort((a, b) => a.name.localeCompare(b.name));
  
  let html = `<table><thead><tr>
    <th style="text-align:left;min-width:160px">Exercise</th>
    <th class="week-cell">Freq</th>
    ${weeks.map(w => `<th class="week-cell">${w.label}</th>`).join('')}
    <th class="week-cell">Total</th>
  </tr></thead><tbody>`;
  
  sortedExercises.forEach(({ name, target }) => {
    html += renderMonthlyRow(name, target, weeks);
  });
  
  return html + `</tbody></table>`;
}

function renderMonthlyRow(name, target, weeks) {
  const ex = findExerciseByName(name);
  let total = 0;
  const freqClass = target === 1 ? 'freq-1x' : target === 3 ? 'freq-3x' : 'freq-2x';
  
  const cells = weeks.map(w => {
    const count = ex ? getCountInRange(ex.id, w.start, w.end) : 0;
    total += count;
    return `<td class="week-cell" style="${count >= target ? 'color:#16a34a;font-weight:600' : ''}">${count || '-'}</td>`;
  }).join('');
  
  const expected = target * weeks.length;
  const complete = total >= expected;
  
  return `<tr class="${complete ? 'complete-row' : ''}">
    <td class="exercise-name">${complete ? '✓ ' : ''}${name}</td>
    <td><span class="freq-badge ${freqClass}">${target}x</span></td>
    ${cells}
    <td><span class="freq-badge" style="${complete ? 'background:#dcfce7;color:#166534' : ''}">${total}/${expected}</span></td>
  </tr>`;
}

function renderYearlyTable() {
  const months = getYearMonthsFrom(state.selectedYear);
  const allEx = getAllExercises();
  
  // Combine and sort alphabetically
  const sortedExercises = allEx.map(name => ({
    name,
    target: getExerciseFrequency(name)
  })).sort((a, b) => a.name.localeCompare(b.name));
  
  let html = `<table><thead><tr>
    <th style="text-align:left;min-width:160px">Exercise</th>
    <th class="week-cell">Freq</th>
    ${months.map(m => `<th class="week-cell">${m.label}</th>`).join('')}
    <th class="week-cell">Total</th>
  </tr></thead><tbody>`;
  
  sortedExercises.forEach(({ name, target }) => {
    html += renderYearlyRow(name, target, months);
  });
  
  return html + `</tbody></table>`;
}

function renderYearlyRow(name, target, months) {
  const ex = findExerciseByName(name);
  let total = 0;
  const freqClass = target === 1 ? 'freq-1x' : target === 3 ? 'freq-3x' : 'freq-2x';
  
  const cells = months.map(m => {
    const count = ex ? getCountInRange(ex.id, m.start, m.end) : 0;
    total += count;
    const expected = target * 4;
    return `<td class="week-cell" style="${count >= expected ? 'color:#16a34a;font-weight:600' : ''}">${count || '-'}</td>`;
  }).join('');
  
  return `<tr>
    <td class="exercise-name">${name}</td>
    <td><span class="freq-badge ${freqClass}">${target}x</span></td>
    ${cells}
    <td><span class="freq-badge">${total}</span></td>
  </tr>`;
}

function renderStatsPage() {
  // Sort all exercises alphabetically
  const sortedExercises = getAllExercises().slice().sort((a, b) => a.localeCompare(b));
  const selected = state.selectedExercise || 'all';
  
  return `
    <div class="card" style="border-radius:0 1rem 1rem 1rem">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Exercise Stats</h1>
      
      <div class="grid" style="grid-template-columns:280px 1fr;gap:1.5rem">
        <!-- Exercise List -->
        <div style="max-height:70vh;overflow-y:auto">
          <div onclick="state.selectedExercise='all';render()" class="exercise-row ${selected === 'all' ? 'selected' : ''}" style="background:${selected === 'all' ? '#eef2ff' : '#f0fdf4'};border:${selected === 'all' ? '2px solid #6366f1' : '2px solid #86efac'};margin-bottom:0.75rem">
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-800">📊 All Exercises</span>
              <span class="text-xs text-green-600 font-semibold">${state.records.length}</span>
            </div>
          </div>
          
          ${sortedExercises.map(name => {
            const e = findExerciseByName(name);
            const s = e ? getExerciseStats(e.id) : null;
            const freq = getExerciseFrequency(name);
            const freqClass = freq === 1 ? 'freq-1x' : freq === 3 ? 'freq-3x' : 'freq-2x';
            return `<div onclick="selectExercise('${name.replace(/'/g, "\\'")}')" class="exercise-row ${selected === name ? 'selected' : ''}">
              <div class="flex justify-between items-center">
                <span class="font-medium text-gray-800">${name}</span>
                <div class="flex items-center gap-2">
                  <span class="freq-badge ${freqClass}">${freq}x</span>
                  ${s && s.count > 0 ? `<span class="text-xs text-green-600 font-semibold">${s.count}</span>` : ''}
                </div>
              </div>
            </div>`;
          }).join('')}
        </div>
        
        <!-- Stats Detail -->
        <div>
          ${selected === 'all' ? renderAllExercisesStats() : renderSingleExerciseStats(selected)}
        </div>
      </div>
    </div>
  `;
}

function renderAllExercisesStats() {
  const stats = getOverallStats();
  
  return `
    <div class="flex items-center gap-3 mb-4">
      <h2 class="text-xl font-bold text-gray-800">📊 Overall Statistics</h2>
    </div>
    
    ${stats.totalRecords > 0 ? `
      <!-- Highlight Card: Do This Now -->
      ${stats.shouldDoNow ? `
        <div class="p-4 rounded-xl grad-orange mb-4 border-2 border-orange-300">
          <p class="text-xs font-bold text-orange-700 mb-1">🎯 DO THIS NOW</p>
          <p class="text-2xl font-bold text-orange-800">${stats.shouldDoNow}</p>
          <p class="text-sm text-orange-600 mt-1">Lowest weekly completion - needs attention!</p>
        </div>
      ` : `
        <div class="p-4 rounded-xl grad-green mb-4 border-2 border-green-300">
          <p class="text-xs font-bold text-green-700 mb-1">✅ ALL CAUGHT UP</p>
          <p class="text-lg font-bold text-green-800">You've completed all exercises for this week!</p>
        </div>
      `}
      
      <!-- Weekly Progress -->
      <div class="p-4 rounded-xl grad-blue mb-4">
        <p class="text-xs font-bold text-blue-700 mb-2">THIS WEEK'S PROGRESS</p>
        <div class="flex items-end gap-4">
          <p class="text-3xl font-bold text-blue-800">${stats.weeklyCompletionRate.toFixed(0)}%</p>
          <p class="text-sm text-blue-600 mb-1">${stats.completedThisWeek} / ${stats.expectedThisWeek} exercises</p>
        </div>
        <div class="progress-bar mt-2"><div class="progress-fill" style="width:${stats.weeklyCompletionRate}%;background:#2563eb"></div></div>
      </div>
      
      <!-- Main Stats Grid -->
      <div class="grid grid-4 gap-3 mb-4">
        <div class="stat-card grad-green"><p class="stat-label text-green-700">Total Logs</p><p class="stat-value text-green-800">${stats.totalRecords}</p></div>
        <div class="stat-card grad-blue"><p class="stat-label text-blue-700">This Week</p><p class="stat-value text-blue-800">${stats.thisWeekCount}</p></div>
        <div class="stat-card grad-purple"><p class="stat-label text-purple-700">Today</p><p class="stat-value text-purple-800">${stats.todayCount}</p></div>
        <div class="stat-card grad-indigo"><p class="stat-label text-indigo-600">Exercises</p><p class="stat-value text-indigo-600">${stats.totalExercises}</p></div>
      </div>
      
      <!-- Streaks -->
      <div class="grid grid-2 gap-3 mb-4">
        <div class="stat-card bg-gray-50 border border-gray-200">
          <p class="stat-label text-gray-600">🔥 Current Streak</p>
          <p class="stat-value text-orange-600">${stats.currentStreak} days</p>
        </div>
        <div class="stat-card bg-gray-50 border border-gray-200">
          <p class="stat-label text-gray-600">🏆 Longest Streak</p>
          <p class="stat-value text-purple-600">${stats.longestStreak} days</p>
        </div>
      </div>
      
      <!-- Best & Most Done -->
      <div class="grid grid-2 gap-3 mb-4">
        <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
          <p class="text-xs text-gray-500 font-semibold mb-1">🥇 MOST DONE EXERCISE</p>
          <p class="font-bold text-gray-800">${stats.mostDoneExercise || 'N/A'}</p>
          <p class="text-sm text-green-600">${stats.mostDoneCount} times</p>
        </div>
        <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
          <p class="text-xs text-gray-500 font-semibold mb-1">📉 LEAST DONE EXERCISE</p>
          <p class="font-bold text-gray-800">${stats.leastDoneExercise || 'N/A'}</p>
          <p class="text-sm text-orange-600">${stats.leastDoneCount === Infinity ? 0 : stats.leastDoneCount} times</p>
        </div>
      </div>
      
      <!-- Day Stats -->
      <div class="grid grid-3 gap-3 mb-4">
        <div class="p-3 rounded-lg bg-gray-50 border border-gray-200 text-center">
          <p class="text-xs text-gray-500 font-semibold">Best Day</p>
          <p class="font-bold text-green-700">${stats.bestDay}</p>
        </div>
        <div class="p-3 rounded-lg bg-gray-50 border border-gray-200 text-center">
          <p class="text-xs text-gray-500 font-semibold">Active Days</p>
          <p class="font-bold text-blue-700">${stats.uniqueDays}</p>
        </div>
        <div class="p-3 rounded-lg bg-gray-50 border border-gray-200 text-center">
          <p class="text-xs text-gray-500 font-semibold">Avg/Day</p>
          <p class="font-bold text-purple-700">${stats.avgPerDay.toFixed(1)}</p>
        </div>
      </div>
      
      <!-- Last 7 Days Activity -->
      <div class="p-4 bg-gray-50 rounded-lg mb-4">
        <p class="text-xs text-gray-500 font-semibold mb-3">LAST 7 DAYS ACTIVITY</p>
        <div class="flex justify-between items-end gap-2" style="height:80px">
          ${stats.last7Days.map(d => {
            const maxCount = Math.max(...stats.last7Days.map(x => x.count), 1);
            const h = (d.count / maxCount) * 100;
            const isToday = d.date === todayStr();
            return `<div class="flex flex-col items-center flex-1">
              <span class="text-xs font-bold text-gray-700 mb-1">${d.count}</span>
              <div style="height:60px;width:100%;display:flex;align-items:flex-end">
                <div style="width:100%;height:${Math.max(h, 5)}%;background:${isToday ? '#6366f1' : '#a5b4fc'};border-radius:4px 4px 0 0"></div>
              </div>
              <span class="text-xs text-gray-500 mt-1">${d.dayName}</span>
            </div>`;
          }).join('')}
        </div>
      </div>
      
      <!-- Never Done -->
      ${stats.neverDone.length > 0 ? `
        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
          <p class="text-xs text-red-600 font-semibold mb-2">⚠️ NEVER DONE (${stats.neverDone.length})</p>
          <div class="flex flex-wrap gap-2">
            ${stats.neverDone.slice(0, 10).map(name => `<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">${name}</span>`).join('')}
            ${stats.neverDone.length > 10 ? `<span class="text-xs text-red-500">+${stats.neverDone.length - 10} more</span>` : ''}
          </div>
        </div>
      ` : ''}
    ` : `
      <div class="p-8 text-center text-gray-500">
        <p class="text-lg mb-2">No data yet</p>
        <p class="text-sm">Start logging exercises to see overall stats!</p>
      </div>
    `}
  `;
}

function renderSingleExerciseStats(selected) {
  const ex = findExerciseByName(selected);
  const stats = ex ? getExerciseStats(ex.id) : null;
  const freq = getExerciseFrequency(selected);
  const freqClass = freq === 1 ? 'freq-1x' : freq === 3 ? 'freq-3x' : 'freq-2x';
  
  return `
    <div class="flex items-center gap-3 mb-4">
      <h2 class="text-xl font-bold text-gray-800">${selected}</h2>
      <span class="freq-badge ${freqClass}">${freq}x/week</span>
    </div>
    
    ${stats && stats.count > 0 ? `
      <!-- Main Stats -->
      <div class="grid grid-4 gap-3 mb-4">
        <div class="stat-card grad-green"><p class="stat-label text-green-700">Max</p><p class="stat-value text-green-800">${stats.max.toFixed(1)}</p></div>
        <div class="stat-card grad-blue"><p class="stat-label text-blue-700">Average</p><p class="stat-value text-blue-800">${stats.avg.toFixed(1)}</p></div>
        <div class="stat-card grad-purple"><p class="stat-label text-purple-700">L7 Avg</p><p class="stat-value text-purple-800">${stats.last7Avg.toFixed(1)}</p></div>
        <div class="stat-card grad-orange"><p class="stat-label text-orange-600">L7/Max</p><p class="stat-value text-orange-600">${stats.l7MaxRatio.toFixed(0)}%</p></div>
      </div>
      
      <div class="grid grid-4 gap-3 mb-4">
        <div class="stat-card grad-indigo"><p class="stat-label text-indigo-600">Min</p><p class="stat-value text-indigo-600">${stats.min.toFixed(1)}</p></div>
        <div class="stat-card grad-teal"><p class="stat-label text-teal-700">Median</p><p class="stat-value text-teal-800">${stats.median.toFixed(1)}</p></div>
        <div class="stat-card bg-gray-100"><p class="stat-label text-gray-600">Std Dev</p><p class="stat-value text-gray-800">${stats.stdDev.toFixed(1)}</p></div>
        <div class="stat-card bg-gray-100"><p class="stat-label text-gray-600">Total</p><p class="stat-value text-gray-800">${stats.total.toFixed(0)}</p></div>
      </div>
      
      <div class="grid grid-3 gap-3 mb-4">
        <div class="stat-card bg-gray-50 border border-gray-200">
          <p class="stat-label text-gray-600">Total Logs</p>
          <p class="stat-value text-gray-800">${stats.count}</p>
        </div>
        <div class="stat-card bg-gray-50 border border-gray-200">
          <p class="stat-label text-gray-600">Best Day</p>
          <p class="text-lg font-bold text-gray-800">${stats.bestDay}</p>
        </div>
        <div class="stat-card bg-gray-50 border border-gray-200">
          <p class="stat-label text-gray-600">Trend (L7 vs Prev)</p>
          <p class="stat-value ${stats.recentTrend >= 0 ? 'text-green-600' : 'text-red-600'}">${stats.recentTrend >= 0 ? '+' : ''}${stats.recentTrend.toFixed(1)}%</p>
        </div>
      </div>
      
      <div class="grid grid-2 gap-3 mb-4">
        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-xs text-gray-500 font-semibold">First Logged</p>
          <p class="font-bold text-gray-800">${new Date(stats.firstDate).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})}</p>
        </div>
        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-xs text-gray-500 font-semibold">Last Logged</p>
          <p class="font-bold text-gray-800">${new Date(stats.lastDate).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})}</p>
        </div>
      </div>
      
      <!-- Mini Chart -->
      <div class="p-4 bg-gray-50 rounded-lg">
        <p class="text-xs text-gray-500 font-semibold mb-3">LAST 30 ENTRIES</p>
        <div class="mini-chart">
          ${stats.chartData.map(r => {
            const h = stats.max > 0 ? (r.amount / stats.max) * 100 : 0;
            return `<div class="mini-bar" style="height:${Math.max(h, 5)}%" title="${r.date}: ${r.amount}"></div>`;
          }).join('')}
        </div>
      </div>
    ` : `
      <div class="p-8 text-center text-gray-500">
        <p class="text-lg mb-2">No data yet</p>
        <p class="text-sm">Start logging this exercise to see stats!</p>
      </div>
    `}
  `;
}

loadState();
render();
</script>
</body>
</html>
